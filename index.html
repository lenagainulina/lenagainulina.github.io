<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expat AI - Your Companion Abroad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fe;
            background-image: radial-gradient(circle at 10% 20%, rgb(222, 228, 249) 0%, rgba(255,255,255,0) 50%);
        }
        .body-no-scroll {
            overflow: hidden;
        }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 10px; }
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
        .chat-bubble { max-width: 80%; word-wrap: break-word; animation: fadeInUp 0.4s ease-out; }
        .ai-typing-indicator span { animation: blink 1.4s infinite both; }
        .ai-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 20% { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Animations for Chat Disco Ball --- */
        @-webkit-keyframes rotateDiscoBall { 0% {-webkit-transform: rotateX(90deg) rotateZ(0deg) rotate(0deg); } 100% {-webkit-transform: rotateX(90deg) rotateZ(360deg) rotate(0deg); } }
        @keyframes rotateDiscoBall { 0% {transform: rotateX(90deg) rotateZ(0deg) rotate(0deg); } 100% {transform: rotateX(90deg) rotateZ(360deg) rotate(0deg); } }
        @-webkit-keyframes rotateDiscoBallMiddle { 0% {-webkit-transform: rotateX(90deg) rotateY(0deg) rotate(0deg); } 100% {-webkit-transform: rotateX(90deg) rotateY(-360deg) rotate(0deg); } }
        @keyframes rotateDiscoBallMiddle { 0% {transform: rotateX(90deg) rotateY(0deg) rotate(0deg); } 100% {transform: rotateX(90deg) rotateY(-360deg) rotate(0deg); } }
        @-webkit-keyframes reflect { 0% {-webkit-filter: brightness(60%);} 50% {-webkit-filter: brightness(120%);} 100% {-webkit-filter: brightness(90%);} }
        @keyframes reflect { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }
        
        /* Feature Card pulse */
        .feature-card:hover .feature-icon { animation: pulse-icon 1.5s infinite; }
        @keyframes pulse-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Chat Disco Ball Avatar - DYNAMIC VERSION */
        .dynamic-disco-container { width: 100%; height: 100%; position: relative; }
        .dynamic-disco-ball-light { width: 32px; height: 32px; position: absolute; top: 0; left: 0; border-radius: 100%; background-color: white; opacity: 0.2; -webkit-filter: blur(6px); filter: blur(6px); }
        .dynamic-disco-ball { -webkit-transform-style: preserve-3d; transform-style: preserve-3d; width: 32px; height: 32px; position: absolute; top: 0; left: 0; -webkit-animation: rotateDiscoBall 18s linear infinite; animation: rotateDiscoBall 18s linear infinite; }
        .dynamic-disco-ball-middle { -webkit-transform-style: preserve-3d; transform-style: preserve-3d; height: 100%; width: 100%; border-radius: 100%; background-color: #111; position: absolute; background: linear-gradient(top, #111, #333); -webkit-animation: rotateDiscoBallMiddle 18s linear infinite; animation: rotateDiscoBallMiddle 18s linear infinite; }
        .dynamic-disco-square { -webkit-transform-style: preserve-3d; transform-style: preserve-3d; position: absolute; top: 16px; left: 16px; width: 2.1px; height: 2.1px; transform: rotateX(90deg) rotateY(0deg) translateZ(0px); }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-5xl h-[90vh] flex flex-col bg-white rounded-3xl shadow-2xl shadow-blue-100/50 overflow-hidden">
            
            <header class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white p-4 sm:p-6 flex items-center justify-between shadow-lg z-10">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold tracking-wide">Expat AI</h1>
                    <p class="text-sm sm:text-base text-purple-100">Chart your course, anywhere in the world.</p>
                </div>
                 <div class="flex items-center space-x-3">
                    <div class="flex-col items-end hidden md:flex">
                        <button id="auth-button" class="flex items-center space-x-2 bg-white/10 hover:bg-white/20 transition-colors p-1.5 rounded-full focus:outline-none focus:ring-2 focus:ring-white/50 mb-1">
                            <div id="auth-avatar-container" class="w-6 h-6 rounded-full bg-pink-200 flex items-center justify-center overflow-hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-pink-700" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <span id="auth-text" class="text-white font-medium text-sm pr-2">Sign In</span>
                        </button>
                        <div id="location-container" class="flex items-center space-x-1 text-sm font-medium text-purple-100 cursor-pointer" title="Click to edit location">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                            <span id="location-text">Detecting...</span>
                            <input type="text" id="location-input" class="hidden bg-transparent border-b-2 border-purple-300 focus:outline-none w-36 text-white placeholder-purple-200">
                        </div>
                    </div>
                    <!-- Mobile Menu Button -->
                    <button id="mobile-toolkit-toggle" class="md:hidden p-2 -mr-2 rounded-full text-purple-200 hover:bg-white/10 hover:text-white transition">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </header>

            <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                
                <!-- Chat Window -->
                <div class="flex-1 flex flex-col p-4 sm:p-6 bg-gray-50/50 overflow-hidden">
                    <div id="chat-messages" class="flex-1 space-y-4 overflow-y-auto pr-2"></div>
                    <div class="mt-4">
                        <form id="chat-form" class="flex items-center space-x-2 sm:space-x-4">
                            <input type="text" id="chat-input" placeholder="Ask anything about expat life..." class="flex-1 w-full px-4 py-3 text-gray-700 bg-white border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 shadow-sm" autocomplete="off">
                            <button type="submit" class="text-white rounded-xl p-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 shadow-lg disabled:opacity-70 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Toolkit Panel -->
                <aside id="toolkit-panel" class="absolute md:relative inset-0 z-30 w-full md:w-2/5 xl:w-1/3 bg-gray-50/95 backdrop-blur-sm md:bg-gray-50/70 md:backdrop-blur-none border-l border-gray-100 p-6 flex-col space-y-6 overflow-y-auto hidden md:flex transition-transform duration-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Your Expat Toolkit</h2>
                            <p class="text-sm text-gray-500 mt-1">Select a feature to get started.</p>
                        </div>
                        <button id="close-toolkit-btn" class="md:hidden p-2 -mr-2 rounded-full text-gray-500 hover:bg-gray-200">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- New Feature: Plan My Journey -->
                    <div id="feature-plan-journey" class="feature-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:border-teal-400 hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="feature-icon bg-teal-100 text-teal-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Plan My Journey</h3>
                                <p class="text-sm text-gray-500">Create a personalized milestone plan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature: Step-by-step Guides -->
                    <div class="feature-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:border-purple-400 hover:shadow-lg transition-all duration-300">
                         <div class="flex items-center space-x-4 cursor-pointer" id="guided-processes-header">
                            <div class="feature-icon bg-purple-100 text-purple-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3m0 0l6-3m-6 3V4" /></svg></div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Step-by-Step Guides</h3>
                                <p class="text-sm text-gray-500">Visa, housing, taxes, and more.</p>
                            </div>
                        </div>
                        <div id="guided-processes-list" class="mt-3 space-y-2 text-sm hidden">
                           <a data-process="visa" class="cursor-pointer block text-purple-700 font-medium p-2 rounded-md hover:bg-purple-50">→ Apply for a Visa</a>
                           <a data-process="anmeldung" class="cursor-pointer block text-purple-700 font-medium p-2 rounded-md hover:bg-purple-50">→ Register Address (Anmeldung)</a>
                           <a data-process="pr" class="cursor-pointer block text-purple-700 font-medium p-2 rounded-md hover:bg-purple-50">→ Apply for Permanent Residence</a>
                           <a data-process="tax" class="cursor-pointer block text-purple-700 font-medium p-2 rounded-md hover:bg-purple-50">→ File a Tax Return</a>
                        </div>
                    </div>
                    
                    <!-- Feature: Find Support -->
                     <div id="feature-find-support" class="feature-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:border-pink-400 hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="feature-icon bg-pink-100 text-pink-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M15 21H3m12 0h6M12 12.5a4.5 4.5 0 110-9 4.5 4.5 0 010 9z" /></svg></div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Find Support</h3>
                                <p class="text-sm text-gray-500">Connect with lawyers & interpreters.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature: Journey Tracker (Now Dynamic) -->
                    <div id="journey-tracker-container" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-semibold text-gray-800">My Journey Tracker</h3>
                        <ul id="journey-tracker-list" class="mt-3 space-y-3 text-sm">
                           <!-- Demo content will be replaced by generated plan -->
                           <li class="flex items-start space-x-3 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                <div>Click "Plan My Journey" to create a personalized checklist here.</div>
                           </li>
                        </ul>
                    </div>
                </aside>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // =====================================================================================
        // CRITICAL: FIREBASE SETUP REQUIRED
        // =====================================================================================
        // The error 'auth/api-key-not-valid' happens because the configuration below is just a
        // placeholder. You MUST replace these values with the actual configuration from your
        // own Firebase project for authentication to work.
        //
        // How to get your Firebase config:
        // 1. Go to https://console.firebase.google.com/
        // 2. Create a new project (or use an existing one).
        // 3. In your project, go to Project Settings (click the gear icon ⚙️).
        // 4. Under the "General" tab, scroll down to "Your apps".
        // 5. Click on the "</>" icon to add a web app (or select your existing web app).
        // 6. You will find the 'firebaseConfig' object there. Copy its values and paste them below.
        // 7. In the Firebase console, go to Authentication -> Sign-in method and enable "Google" as a provider.
        // =====================================================================================
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
            projectId: "PASTE_YOUR_PROJECT_ID_HERE",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "PASTE_YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "PASTE_YOUR_APP_ID_HERE"
        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const submitButton = chatForm.querySelector('button');
        
        // Feature elements
        const featurePlanJourney = document.getElementById('feature-plan-journey');
        const guidedProcessesHeader = document.getElementById('guided-processes-header');
        const guidedProcessesList = document.getElementById('guided-processes-list');
        const featureFindSupport = document.getElementById('feature-find-support');
        const journeyTrackerList = document.getElementById('journey-tracker-list');
        
        // Auth elements
        const authButton = document.getElementById('auth-button');
        const authAvatarContainer = document.getElementById('auth-avatar-container');
        const authText = document.getElementById('auth-text');
        
        // Mobile toolkit elements
        const mobileToolkitToggle = document.getElementById('mobile-toolkit-toggle');
        const toolkitPanel = document.getElementById('toolkit-panel');
        const closeToolkitBtn = document.getElementById('close-toolkit-btn');

        // Location elements
        const locationContainer = document.getElementById('location-container');
        const locationText = document.getElementById('location-text');
        const locationInput = document.getElementById('location-input');
        
        // --- State Management ---
        let chatHistory = [];
        const discoColors = ['#4f46e5','#6366f1','#818cf8','#9333ea','#a855f7','#c084fc','#db2777','#ec4899','#f472b6','#a5b4fc','#d8b4fe','#fbcfe8','#f1f5f9'];
        let awaitingJourneyInfo = false;
        
        let systemPrompt = `You are "Expat AI," a friendly, knowledgeable, and empathetic assistant for people living abroad, specifically in Germany. Your primary goal is to provide clear, accurate, and actionable information.
        - **Core Persona:** You are supportive, clear, and an expert on German bureaucracy and expat life.
        - **Formatting:** Use Markdown extensively. Use lists, bold text, and code blocks to structure information for easy reading.
        - **Context:** Assume the user is in Frankfurt, Germany, unless they specify otherwise.
        - **Conversational Context:** The user may be replying to a clarifying question you just asked. Use the context of the recent conversation to understand their request fully. For example, if you ask "What kind of support do you need?" and they reply "lawyers", understand that they are asking for lawyers in their specified location.
        - **Guided Processes:** When asked for a step-by-step guide (visa, anmeldung, etc.), provide a detailed, numbered list of actions the user needs to take. Be comprehensive.
        - **Finding Support:** When asked for support, provide a list of resources like official government websites, reputable expat forums, and types of professionals to contact (e.g., "Steuerberater" for taxes, "Rechtsanwalt" for legal issues). Use your search tool to find current information if needed.
        - **Safety:** Do not provide financial or legal advice. You can provide information and resources, but always advise the user to consult with a qualified professional.`;

        const addMessageToUI = (sender, message, sources = []) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'items-end', 'chat-bubble');
            const avatar = document.createElement('div');
            avatar.classList.add('w-8', 'h-8', 'rounded-full', 'flex-shrink-0', 'flex', 'items-center', 'justify-center', 'shadow-md', 'overflow-hidden');
            const messageContent = document.createElement('div');
            messageContent.classList.add('mx-3', 'p-3', 'rounded-xl', 'shadow-sm');

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                avatar.classList.add('order-2', 'p-0');
                const currentUser = auth.currentUser;
                if (currentUser && currentUser.photoURL) {
                     avatar.innerHTML = `<img src="${currentUser.photoURL}" alt="User Avatar" class="w-full h-full">`;
                } else {
                    avatar.classList.add('bg-pink-200');
                    avatar.innerHTML = `<img src="https://openmoji.org/data/color/svg/1F984.svg" alt="User Avatar" class="w-full h-full p-1">`;
                }

                messageContent.classList.add('bg-gradient-to-br', 'from-indigo-500', 'to-purple-600', 'text-white', 'order-1');
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            } else { 
                messageWrapper.classList.add('justify-start');
                avatar.classList.add('relative', 'p-0', 'bg-transparent', 'shadow-none');
                messageContent.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-100');
                let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n\s*-\s/g, '<br>• ').replace(/^\s*-\s/, '• ').replace(/\n/g, '<br>');
                messageContent.innerHTML = formattedMessage;

                if (sources.length > 0) {
                    const sourcesContainer = document.createElement('div');
                    sourcesContainer.classList.add('mt-3', 'border-t', 'pt-2');
                    sourcesContainer.innerHTML = '<h4 class="text-xs font-semibold text-gray-500 mb-1">Sources:</h4>';
                    const sourcesList = document.createElement('ul');
                    sourcesList.classList.add('list-none', 'space-y-1');
                    sources.forEach((source, index) => {
                        sourcesList.innerHTML += `<li class="text-xs"><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">${index + 1}. ${source.title}</a></li>`;
                    });
                    sourcesContainer.appendChild(sourcesList);
                    messageContent.appendChild(sourcesContainer);
                }
            }

            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageContent);
            chatMessages.appendChild(messageWrapper);

            if (sender === 'ai') {
                createDynamicDiscoBall(avatar);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        
        const showTypingIndicator = () => {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.classList.add('flex', 'items-end', 'chat-bubble');
            typingIndicator.innerHTML = `<div id="typing-avatar" class="relative w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center shadow-md p-0 bg-transparent overflow-hidden"></div><div class="mx-3 p-3 rounded-xl bg-white border border-gray-100 shadow-sm text-gray-800 ai-typing-indicator"><span class="inline-block w-2 h-2 bg-gray-400 rounded-full"></span><span class="inline-block w-2 h-2 bg-gray-400 rounded-full"></span><span class="inline-block w-2 h-2 bg-gray-400 rounded-full"></span></div>`;
            chatMessages.appendChild(typingIndicator);
            
            const typingAvatar = document.getElementById('typing-avatar');
            if (typingAvatar) {
                createDynamicDiscoBall(typingAvatar);
                typingAvatar.removeAttribute('id');
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        const removeTypingIndicator = () => {
            document.getElementById('typing-indicator')?.remove();
        };
        
        const getAIResponse = async (userQuery) => {
            showTypingIndicator();
            submitButton.disabled = true;
            chatInput.disabled = true;
            
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            const lol = "AIzaSyCfGj-O5QwIxorqqHE5NQZXZdFGSM5LuNs";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${lol}`;

            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            let attempts = 0;
            const maxAttempts = 5;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        addMessageToUI('ai', text, []);
                        chatHistory.push({ role: "model", parts: [{ text: text }] });

                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata?.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(s => s.uri && s.title);
                        }
                        const lastMessage = chatMessages.querySelector('.chat-bubble:last-child .p-3');
                        if(sources.length > 0 && lastMessage) {
                            const sourcesContainer = document.createElement('div');
                            sourcesContainer.classList.add('mt-3', 'border-t', 'pt-2');
                            sourcesContainer.innerHTML = '<h4 class="text-xs font-semibold text-gray-500 mb-1">Sources:</h4>';
                            const sourcesList = document.createElement('ul');
                            sourcesList.classList.add('list-none', 'space-y-1');
                            sources.forEach((source, index) => {
                                sourcesList.innerHTML += `<li class="text-xs"><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">${index + 1}. ${source.title}</a></li>`;
                            });
                            sourcesContainer.appendChild(sourcesList);
                            lastMessage.appendChild(sourcesContainer);
                        }

                    } else {
                        const safetyReason = candidate?.finishReason;
                        const errorMessage = safetyReason === 'SAFETY' 
                            ? "I can't answer that as it might violate my safety policies. Please ask something else."
                            : "I'm sorry, I couldn't generate a response. Please try again.";
                        addMessageToUI('ai', errorMessage);
                        chatHistory.pop(); 
                    }
                    break; 
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts >= maxAttempts) {
                         addMessageToUI('ai', "Sorry, I'm having connection issues. Please check your network and try again later.");
                         chatHistory.pop();
                    } else {
                        await new Promise(res => setTimeout(res, 1000 * 2 ** attempts));
                    }
                }
            }
            removeTypingIndicator();
            submitButton.disabled = false;
            chatInput.disabled = false;
            chatInput.focus();
        };

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (userInput) {
                addMessageToUI('user', userInput);
                if (awaitingJourneyInfo) {
                    awaitingJourneyInfo = false;
                    generateJourneyPlan(userInput);
                } else {
                    getAIResponse(userInput);
                }
                chatInput.value = '';
            }
        });
        
        const startContextualConversation = (userAction, clarifyingQuestion) => {
            addMessageToUI('user', userAction);
            chatHistory.push({ role: 'user', parts: [{ text: userAction }] });
            addMessageToUI('ai', clarifyingQuestion);
            chatHistory.push({ role: 'model', parts: [{ text: clarifyingQuestion }] });
        };

        featurePlanJourney.addEventListener('click', () => {
            const userAction = "I want to plan my expat journey.";
            const clarifyingQuestion = "Great! To create your personalized timeline, could you please tell me your planned move-in date and your primary reason for moving (e.g., job offer, studies)?";
            startContextualConversation(userAction, clarifyingQuestion);
            awaitingJourneyInfo = true;
        });

        guidedProcessesHeader.addEventListener('click', () => {
            guidedProcessesList.classList.toggle('hidden');
        });

        guidedProcessesList.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                const process = e.target.dataset.process;
                let userAction = '', clarifyingQuestion = '';
                const currentLocation = locationText.textContent || 'Germany';
                switch(process) {
                    case 'visa': 
                        userAction = "I need a guide on how to apply for a visa.";
                        clarifyingQuestion = "I can definitely provide a step-by-step guide. To give you the most accurate information, could you please tell me your nationality?";
                        break;
                    case 'anmeldung': 
                        userAction = "I need to register my address (Anmeldung).";
                        clarifyingQuestion = `Of course. The 'Anmeldung' is a crucial step. I'll walk you through the process for ${currentLocation}. Just to confirm, is that the correct city?`;
                        break;
                    case 'pr':
                        userAction = "I want to apply for Permanent Residence.";
                        clarifyingQuestion = "Applying for Permanent Residence is a big milestone! The requirements can vary. Could you tell me what type of permit you currently hold?";
                        break;
                    case 'tax':
                        userAction = "I need help filing a tax return.";
                        clarifyingQuestion = "I can guide you through the tax return process. Are you filing as a full-time employee, a freelancer, or something else?";
                        break;
                }
                if (userAction && clarifyingQuestion) startContextualConversation(userAction, clarifyingQuestion);
            }
        });
        
        featureFindSupport.addEventListener('click', () => {
            const userAction = "I need to find professional support.";
            const currentLocation = locationText.textContent || 'your area';
            const clarifyingQuestion = `Of course! To find the right help, could you tell me what type of support you need in <strong>${currentLocation}</strong>? <br><br> For example: <ul><li class="ml-4">- Lawyers</li><li class="ml-4">- Tax Advisors</li><li class="ml-4">- Interpreters</li></ul>`;
            startContextualConversation(userAction, clarifyingQuestion);
        });

        const initializeLocationDetector = () => {
            const handleLocationSuccess = async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    const location = data.address.city && data.address.country ? `${data.address.city}, ${data.address.country}` : 'Location found';
                    locationText.textContent = location;
                    updateSystemPromptContext(location);
                } catch (error) {
                    console.error("Reverse geocoding failed:", error);
                    handleLocationError({ code: -1, message: "Geocoding service failed." });
                }
            };
            const handleLocationError = (error) => {
                console.warn(`Location error (${error.code}): ${error.message}`);
                locationText.textContent = 'Frankfurt, Germany';
                updateSystemPromptContext('Frankfurt, Germany');
            };
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(handleLocationSuccess, handleLocationError);
            } else {
                handleLocationError({ code: -1, message: "Geolocation is not supported by this browser." });
            }
            locationContainer.addEventListener('click', () => {
                locationText.classList.add('hidden');
                locationInput.classList.remove('hidden');
                locationInput.value = locationText.textContent;
                locationInput.focus();
            });
            const saveLocation = () => {
                const newLocation = locationInput.value.trim();
                if (newLocation) {
                    locationText.textContent = newLocation;
                    updateSystemPromptContext(newLocation);
                }
                locationInput.classList.add('hidden');
                locationText.classList.remove('hidden');
            };
            locationInput.addEventListener('blur', saveLocation);
            locationInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') saveLocation();
                else if (e.key === 'Escape') {
                    locationInput.classList.add('hidden');
                    locationText.classList.remove('hidden');
                }
            });
        };

        const updateSystemPromptContext = (newLocation) => {
            systemPrompt = systemPrompt.replace(/Assume the user is in .*?\./, `Assume the user is in ${newLocation}.`);
            console.log("System prompt context updated to:", newLocation);
        };
        
        const randomNumber = (min, max) => Math.floor(Math.random()*(max-min+1))+min;

        const createDynamicDiscoBall = (container) => {
            if (!container) return;
            container.innerHTML = `<div class="dynamic-disco-ball-light"></div><div class="dynamic-disco-ball"><div class="dynamic-disco-ball-middle"></div></div>`;
            const discoBall = container.querySelector('.dynamic-disco-ball');
            if (!discoBall) return;
            const radius = 16, squareSize = 2.1, prec = 19.55, fuzzy = 0.001, inc = (Math.PI - fuzzy) / prec;
            for(let t = fuzzy; t < Math.PI; t += inc) {
                const z = radius * Math.cos(t), currentRadius = Math.abs((radius * Math.cos(0) * Math.sin(t)) - (radius * Math.cos(Math.PI) * Math.sin(t))) / 2.5;
                const circumference = Math.abs(2 * Math.PI * currentRadius), squaresThatFit = Math.floor(circumference / squareSize), angleInc = (Math.PI * 2 - fuzzy) / squaresThatFit;
                for(let i = angleInc / 2 + fuzzy; i < (Math.PI * 2); i += inc) {
                    const square = document.createElement("div"), squareTile = document.createElement("div");
                    square.className = "dynamic-disco-square";
                    squareTile.style.width = `${squareSize}px`;
                    squareTile.style.height = `${squareSize}px`;
                    squareTile.style.transformOrigin = "0 0 0";
                    squareTile.style.webkitTransform = `rotate(${i}rad) rotateY(${t}rad)`;
                    squareTile.style.transform = `rotate(${i}rad) rotateY(${t}rad)`;
                    squareTile.style.backgroundColor = discoColors[randomNumber(0, discoColors.length - 1)];
                    squareTile.style.webkitAnimation = `reflect 2s linear infinite ${randomNumber(0,20)/10}s`;
                    squareTile.style.animation = `reflect 2s linear infinite ${randomNumber(0,20)/10}s`;
                    squareTile.style.backfaceVisibility = "hidden";
                    square.appendChild(squareTile);
                    const x = radius * Math.cos(i) * Math.sin(t), y = radius * Math.sin(i) * Math.sin(t);
                    square.style.webkitTransform = `translateX(${Math.ceil(x)}px) translateY(${y}px) translateZ(${z}px)`;
                    square.style.transform = `translateX(${x}px) translateY(${y}px) translateZ(${z}px)`;
                    discoBall.appendChild(square);
                }
            }
        };

        const renderJourneyPlan = (milestones) => {
            journeyTrackerList.innerHTML = ''; // Clear existing content
            if (!milestones || milestones.length === 0) {
                journeyTrackerList.innerHTML = `<li class="text-gray-500">Sorry, I couldn't create a plan with the information provided. Please try again.</li>`;
                return;
            }

            milestones.forEach(item => {
                const li = document.createElement('li');
                li.classList.add('flex', 'items-start', 'space-x-3', 'text-gray-600');
                
                const icon = item.status === 'Done' 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500 flex-shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>`;

                li.innerHTML = `${icon}<div><span class="font-medium text-gray-800">${item.milestone}</span><br>Due: <span class="text-amber-600 font-semibold">${item.dueDate}</span></div>`;
                journeyTrackerList.appendChild(li);
            });
        };

        const generateJourneyPlan = async (userInfo) => {
            addMessageToUI('ai', "Great! Let me draft a personalized journey plan for you. This might take a moment...");
            journeyTrackerList.innerHTML = `<li class="text-gray-500 animate-pulse">Generating your plan...</li>`;

            const lol = "AIzaSyCfGj-O5QwIxorqqHE5NQZXZdFGSM5LuNs";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${lol}`;
            const plannerSystemPrompt = `You are a specialized AI assistant for creating structured expat journey plans. The user will provide their moving details. Your task is to generate a JSON array of milestones. Each milestone must be an object with three properties: "milestone" (a string describing the task), "dueDate" (a string with an estimated date or timeframe), and "status" (a string, always "To Do"). Base the timeline on the current date of ${new Date().toLocaleDateString()}.`;

            const planRequestHistory = [
                ...chatHistory,
                {
                    role: 'user',
                    parts: [{ text: `Here is my information: ${userInfo}`}]
                }
            ];

            const payload = {
                contents: planRequestHistory,
                systemInstruction: { parts: [{ text: plannerSystemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "milestone": { "type": "STRING" },
                                "dueDate": { "type": "STRING" },
                                "status": { "type": "STRING" },
                            },
                            required: ["milestone", "dueDate", "status"]
                        }
                    }
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const plan = JSON.parse(jsonText);
                    renderJourneyPlan(plan);
                    addMessageToUI('ai', "I've created your personalized plan! You can see the milestones in the 'My Journey Tracker' on the right.");
                } else {
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                console.error("Failed to generate journey plan:", error);
                addMessageToUI('ai', "I'm sorry, I had trouble creating your plan. Could you please try rephrasing your information?");
                renderJourneyPlan([]); // Renders the error message in the tracker
            }
        };

        // --- Authentication Logic ---
        const handleSignIn = () => {
            signInWithPopup(auth, provider).catch((error) => console.error("Sign in error", error));
        };

        const handleSignOut = () => {
            signOut(auth).catch((error) => console.error("Sign out error", error));
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                authText.textContent = user.displayName || 'Explorer';
                authAvatarContainer.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="w-full h-full">`;
                authButton.onclick = handleSignOut;
            } else {
                // User is signed out
                authText.textContent = 'Sign In';
                authAvatarContainer.innerHTML = `<img src="https://openmoji.org/data/color/svg/1F984.svg" alt="Profile Avatar" class="w-full h-full p-0.5">`;
                authButton.onclick = handleSignIn;
            }
        });


        window.addEventListener('load', () => {
             const initialGreeting = 'Hello! How can I help you with your expat journey today? Select a feature on the right or ask me a question.';
             addMessageToUI('ai', initialGreeting);
             chatHistory.push({ role: 'model', parts: [{ text: initialGreeting }] });
             chatInput.focus();
             
             // The onAuthStateChanged will handle the initial auth state, so no need to set unicorn here.
             
             initializeLocationDetector();
        });
    </script>
</body>
</html>
